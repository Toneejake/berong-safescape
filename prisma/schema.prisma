generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
model User {
  id            Int            @id @default(autoincrement())
  username      String         @unique
  email         String?        @unique
  password      String
  name          String
  age           Int?
  role          UserRole       @default(guest)
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Enhanced Profile Fields (Analytics Module)
  barangay              String?
  school                String?
  schoolOther           String?  // For "Other (specify)" option
  occupation            String?
  occupationOther       String?  // For "Other (specify)" option
  gender                String?
  gradeLevel            String?  // For kids/students
  
  // Assessment Scores
  preTestScore          Int?
  postTestScore         Int?
  preTestCompletedAt    DateTime?
  postTestCompletedAt   DateTime?
  
  // Engagement Tracking
  engagementPoints      Int      @default(0)
  totalTimeSpentMinutes Int      @default(0)
  lastActiveAt          DateTime @default(now())
  
  // Data Privacy & Profile Status
  dataPrivacyConsent    Boolean  @default(false)
  profileCompleted      Boolean  @default(false)
  
  blogPosts             BlogPost[]
  progress              UserProgress[]
  quizResults           QuizResult[]
  notifications         Notification[]
  safeScapeProgress     SafeScapeProgress[]
  assessmentAnswers     UserAnswer[]
  engagementLogs        EngagementLog[]
  floorPlans            FloorPlan[]

  @@map("users")
}

model QuickQuestion {
  id           Int                   @id @default(autoincrement())
  category     QuickQuestionCategory
  questionText String
  responseText String
  order        Int                   @default(0)
  isActive     Boolean               @default(true)
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt

  @@map("quick_questions")
}

model BlogPost {
  id          Int             @id @default(autoincrement())
  title       String
  excerpt     String
  content     String
  imageUrl    String?
  category    ContentCategory
  authorId    Int
  isPublished Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  author      User            @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@map("blog_posts")
}

model Video {
  id          Int             @id @default(autoincrement())
  title       String
  description String?
  youtubeId   String
  category    ContentCategory
  duration    String?
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@map("videos")
}

model KidsModule {
  id          Int            @id @default(autoincrement())
  title       String
  description String?
  dayNumber   Int            @unique
  content     String
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  progress    UserProgress[]

  @@map("kids_modules")
}

model UserProgress {
  id          Int        @id @default(autoincrement())
  userId      Int
  moduleId    Int
  completed   Boolean    @default(false)
  score       Int        @default(0)
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  module      KidsModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleId])
  @@map("user_progress")
}

model QuizResult {
  id          Int      @id @default(autoincrement())
  userId      Int
  quizType    String
  score       Int      @default(0)
  maxScore    Int      @default(0)
  completedAt DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("quiz_results")
}

enum UserRole {
  guest
  kid
  adult
  professional
  admin
}

enum ContentCategory {
  kids
  adult
  professional
}

enum QuickQuestionCategory {
  emergency
  prevention
  equipment
  general
}

model Notification {
  id          Int      @id @default(autoincrement())
  userId      Int      // User who receives the notification
  title       String
  message     String
  type        String   // 'blog', 'video', 'system', etc.
  category    String   // 'adult', 'professional', 'kids'
  isRead      Boolean  @default(false)
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model FireCodeSection {
  id            Int     @id @default(autoincrement())
  title         String
  sectionNum    String
  content       String
  parentSectionId Int?
  order         Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  parentSection FireCodeSection? @relation(fields: [parentSectionId], references: [id], onDelete: Cascade, name: "ParentSubSection")
  subSections   FireCodeSection[] @relation(name: "ParentSubSection")
}

model CarouselImage {
  id        Int      @id @default(autoincrement())
  title     String
  altText   String?
  imageUrl  String
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("carousel_images")
}

model SafeScapeProgress {
  id          Int       @id @default(autoincrement())
  userId      Int
  moduleNum   Int       // 1-5 for the 5 SafeScape modules
  sectionData String    // JSON string storing section completion status
  completed   Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, moduleNum])
  @@map("safescape_progress")
}

// ============================================
// ENHANCED ANALYTICS & ASSESSMENT MODELS
// ============================================

model AssessmentQuestion {
  id              Int            @id @default(autoincrement())
  question        String
  options         Json           // Array of 4 options: string[]
  correctAnswer   Int            // Index of correct answer (0-3)
  explanation     String
  category        String         // From ASSESSMENT_CATEGORIES
  difficulty      String         @default("Medium") // Easy, Medium, Hard
  isActive        Boolean        @default(true)
  forRoles        Json           // ["kid", "adult", "professional"] - Using Json for SQLite compatibility
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  userAnswers     UserAnswer[]

  @@map("assessment_questions")
}

model UserAnswer {
  id             Int                 @id @default(autoincrement())
  userId         Int
  questionId     Int
  selectedAnswer Int                 // Index of selected answer (0-3)
  isCorrect      Boolean
  testType       String              // "preTest" or "postTest"
  answeredAt     DateTime            @default(now())
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  question       AssessmentQuestion  @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@map("user_answers")
}

model EngagementLog {
  id          Int      @id @default(autoincrement())
  userId      Int
  eventType   String   // "quiz", "game", "video", "module", "login", "preTest", "postTest"
  eventData   Json?    // Additional data: { quizType, score, duration, etc }
  points      Int      @default(0)
  loggedAt    DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, loggedAt])
  @@map("engagement_logs")
}

model AnalyticsCache {
  id          Int      @id @default(autoincrement())
  cacheKey    String   @unique
  cacheData   Json
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([cacheKey, expiresAt])
  @@map("analytics_cache")
}

// Floor Plan Library for Simulation
model FloorPlan {
  id              Int         @id @default(autoincrement())
  name            String
  description     String?
  gridData        Json        // The 256x256 grid as JSON array
  thumbnail       String?     // Base64 thumbnail image
  originalImage   String?     // Base64 original floor plan image
  
  // Ownership & Visibility
  userId          Int
  uploaderName    String      // Denormalized for display
  isPublic        Boolean     @default(false)
  
  // Clone tracking (like git)
  clonedFromId    Int?        // ID of parent floor plan if cloned
  clonedFrom      FloorPlan?  @relation("FloorPlanClones", fields: [clonedFromId], references: [id])
  clones          FloorPlan[] @relation("FloorPlanClones")
  
  // Metadata
  gridWidth       Int         @default(256)
  gridHeight      Int         @default(256)
  exitCount       Int         @default(0)
  
  // Processing info
  processingMethod String     @default("unet") // "unet", "gemini", "manual"
  threshold        Float?     // U-Net threshold used
  invertMask       Boolean?   // Whether mask was inverted
  
  // Timestamps
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isPublic])
  @@index([clonedFromId])
  @@map("floor_plans")
}